<UserControl x:Class="UI_ChausseeNeuve.Views.ResultatView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:UI_ChausseeNeuve.Views"
             xmlns:vm="clr-namespace:UI_ChausseeNeuve.ViewModels"
             xmlns:c="clr-namespace:UI_ChausseeNeuve.Converters"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             MinWidth="1000"
             MinHeight="700">

    <UserControl.DataContext>
        <vm:ResultatViewModel/>
    </UserControl.DataContext>

    <UserControl.Resources>
        <!-- Styles locaux -->
        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Margin" Value="0,0,0,16"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="Gray" BlurRadius="6" ShadowDepth="2" Opacity="0.3"/>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="TitleStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="#2D3748"/>
            <Setter Property="Margin" Value="0,0,0,12"/>
        </Style>

        <Style x:Key="InfoStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Foreground" Value="#4A5568"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
        </Style>

        <Style x:Key="CellStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Foreground" Value="#2D3748"/>
            <Setter Property="TextAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Padding" Value="3"/>
            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
        </Style>

        <Style x:Key="CompactCellStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="Foreground" Value="#2D3748"/>
            <Setter Property="TextAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="LineHeight" Value="12"/>
            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
        </Style>

        <Style x:Key="NumericCellStyle" TargetType="TextBlock" BasedOn="{StaticResource CompactCellStyle}">
            <Setter Property="FontFamily" Value="Consolas, Courier New"/>
            <Setter Property="FontSize" Value="9"/>
        </Style>

        <Style x:Key="ActionButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#007ACC"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="6"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#005999"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="HelpButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#6c757d"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="6"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#495057"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Converters locaux -->
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        
        <c:SimpleBooleanToRowColorConverter x:Key="BooleanToRowColorConverter"/>
        <c:SimpleBooleanToStatusColorConverter x:Key="BooleanToStatusColorConverter"/>
        <c:SimpleCountToVisibilityConverter x:Key="CountToVisibilityConverter"/>

        <!-- Liste statique des criteres -->
        <x:Array x:Key="ListeCriteres" Type="sys:String">
            <sys:String>EpsiT</sys:String>
            <sys:String>SigmaT</sys:String>
            <sys:String>EpsiZ</sys:String>
        </x:Array>

        <!-- Template pour afficher une couche -->
        <DataTemplate x:Key="CoucheTemplate">
            <Border BorderBrush="#DEE2E6" BorderThickness="0,0,0,1" Padding="5">
                <Border.Background>
                    <SolidColorBrush Color="{Binding EstValide, Converter={StaticResource BooleanToRowColorConverter}}"/>
                </Border.Background>
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="50"/><!-- N -->
                        <ColumnDefinition Width="85"/><!-- Interface -->
                        <ColumnDefinition Width="100"/><!-- Nature -->
                        <ColumnDefinition Width="140"/><!-- Materiau -->
                        <ColumnDefinition Width="70"/><!-- Niveaux -->
                        <ColumnDefinition Width="80"/><!-- Module -->
                        <ColumnDefinition Width="55"/><!-- nu -->
                        <ColumnDefinition Width="70"/><!-- Critere -->
                        <ColumnDefinition Width="70"/><!-- sigT -->
                        <ColumnDefinition Width="70"/><!-- epsT -->
                        <ColumnDefinition Width="70"/><!-- sigZ -->
                        <ColumnDefinition Width="70"/><!-- epsZ -->
                        <ColumnDefinition Width="70"/><!-- w -->
                        <ColumnDefinition Width="80"/><!-- Val Adm -->
                        <ColumnDefinition Width="60"/><!-- OK -->
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="{Binding NiveauDisplay}" Style="{StaticResource CellStyle}"/>
                    <!-- Afficher le nom de l interface uniquement si different de la nature -->
                    <TextBlock Grid.Column="1" Text="{Binding InterfaceAffichee}" FontWeight="Medium" Style="{StaticResource CellStyle}"/>
                    <TextBlock Grid.Column="2" Text="{Binding Nature}" Style="{StaticResource CellStyle}"/>
                    <TextBlock Grid.Column="3" Text="{Binding Materiau}" Style="{StaticResource CellStyle}"/>
                    
                    <StackPanel Grid.Column="4" VerticalAlignment="Center" Margin="0">
                        <TextBlock Text="{Binding NiveauSup, StringFormat='{}{0:F0}'}" Style="{StaticResource CompactCellStyle}" Margin="0,-1,0,-1"/>
                        <TextBlock Text="{Binding NiveauInfDisplay}" Style="{StaticResource CompactCellStyle}" Margin="0,-1,0,-1"/>
                    </StackPanel>

                    <TextBlock Grid.Column="5" Text="{Binding Module, StringFormat='{}{0:F0}'}" Style="{StaticResource CellStyle}"/>
                    <TextBlock Grid.Column="6" Text="{Binding CoefficientPoisson, StringFormat='{}{0:F2}'}" Style="{StaticResource CellStyle}"/>
                    
                    <!-- Nouvelle colonne Critere -->
                    <ComboBox Grid.Column="7" ItemsSource="{StaticResource ListeCriteres}" SelectedItem="{Binding Critere, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Margin="2" FontSize="10" Width="65" HorizontalContentAlignment="Center" VerticalContentAlignment="Center"/>
                    
                    <StackPanel Grid.Column="8" VerticalAlignment="Center" Margin="0">
                        <TextBlock Text="{Binding SigmaTSup, StringFormat='{}{0:F3}'}" Margin="0,-1,0,-1">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource NumericCellStyle}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Critere}" Value="SigmaT">
                                            <Setter Property="FontWeight" Value="Normal"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <TextBlock Margin="0,-1,0,-1">
                            <TextBlock.Style>
                                <Style BasedOn="{StaticResource NumericCellStyle}" TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding SigmaTInf, StringFormat='{}{0:F3}'}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding EstPlateforme}" Value="True">
                                            <Setter Property="Text" Value="-"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Critere}" Value="SigmaT">
                                            <Setter Property="FontWeight" Value="Bold"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding SigmaTInfDepasse}" Value="True">
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="Background" Value="#dc3545"/>
                                            <Setter Property="FontWeight" Value="Bold"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                    <StackPanel Grid.Column="9" VerticalAlignment="Center" Margin="0">
                        <TextBlock Text="{Binding EpsilonTSup, StringFormat='{}{0:F1}'}" Margin="0,-1,0,-1">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource NumericCellStyle}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Critere}" Value="EpsiT">
                                            <Setter Property="FontWeight" Value="Normal"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <TextBlock Margin="0,-1,0,-1">
                            <TextBlock.Style>
                                <Style BasedOn="{StaticResource NumericCellStyle}" TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding EpsilonTInf, StringFormat='{}{0:F1}'}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding EstPlateforme}" Value="True">
                                            <Setter Property="Text" Value="-"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Critere}" Value="EpsiT">
                                            <Setter Property="FontWeight" Value="Bold"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding EpsilonTInfDepasse}" Value="True">
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="Background" Value="#dc3545"/>
                                            <Setter Property="FontWeight" Value="Bold"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                    
                    <StackPanel Grid.Column="10" VerticalAlignment="Center" Margin="0">
                        <TextBlock Text="{Binding SigmaZSup, StringFormat='{}{0:F3}'}" Style="{StaticResource NumericCellStyle}" Foreground="Red" Margin="0,-1,0,-1"/>
                        <TextBlock Margin="0,-1,0,-1">
                            <TextBlock.Style>
                                <Style BasedOn="{StaticResource NumericCellStyle}" TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="Red"/>
                                    <Setter Property="Text" Value="{Binding SigmaZInf, StringFormat='{}{0:F3}'}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding EstPlateforme}" Value="True">
                                            <Setter Property="Text" Value="-"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                    
                    <StackPanel Grid.Column="11" VerticalAlignment="Center" Margin="0">
                        <TextBlock Margin="0,-1,0,-1">
                            <TextBlock.Style>
                                <Style BasedOn="{StaticResource NumericCellStyle}" TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding EpsilonZSupDisplay}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Critere}" Value="EpsiZ">
                                            <Setter Property="FontWeight" Value="Bold"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding EpsilonZSupDepasse}" Value="True">
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="Background" Value="#dc3545"/>
                                            <Setter Property="FontWeight" Value="Bold"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <TextBlock Margin="0,-1,0,-1">
                            <TextBlock.Style>
                                <Style BasedOn="{StaticResource NumericCellStyle}" TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding EpsilonZInf, StringFormat='{}{0:F1}'}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding EstPlateforme}" Value="True">
                                            <Setter Property="Text" Value="-"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Critere}" Value="EpsiZ">
                                            <Setter Property="Opacity" Value="0.35"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                    <!-- Valeur admissible avec coloration si depassement -->
                    <TextBlock Grid.Column="13" Margin="0,-1,0,-1">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource NumericCellStyle}">
                                <Setter Property="Text" Value="{Binding ValeurAdmissible, StringFormat='{}{0:F1}'}"/>
                                <Setter Property="Foreground" Value="Blue"/>
                                <Setter Property="FontWeight" Value="Bold"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding EpsilonZSupDepasse}" Value="True">
                                        <Setter Property="Foreground" Value="White"/>
                                        <Setter Property="Background" Value="#dc3545"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding SigmaTInfDepasse}" Value="True">
                                        <Setter Property="Foreground" Value="White"/>
                                        <Setter Property="Background" Value="#dc3545"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding EpsilonTInfDepasse}" Value="True">
                                        <Setter Property="Foreground" Value="White"/>
                                        <Setter Property="Background" Value="#dc3545"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                    <TextBlock Grid.Column="14" Text="{Binding StatutValidation}" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="16">
                        <TextBlock.Foreground>
                            <Binding Path="EstValide" Converter="{StaticResource BooleanToStatusColorConverter}"/>
                        </TextBlock.Foreground>
                    </TextBlock>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- Template pour afficher une interface -->
        <DataTemplate x:Key="InterfaceTemplate">
            <Grid Height="25">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="85"/>
                    <ColumnDefinition Width="100"/>
                    <ColumnDefinition Width="140"/>
                    <ColumnDefinition Width="70"/>
                    <ColumnDefinition Width="80"/>
                    <ColumnDefinition Width="55"/>
                    <ColumnDefinition Width="70"/>
                    <ColumnDefinition Width="70"/>
                    <ColumnDefinition Width="70"/>
                    <ColumnDefinition Width="70"/>
                    <ColumnDefinition Width="70"/>
                    <ColumnDefinition Width="70"/>
                    <ColumnDefinition Width="80"/>
                    <ColumnDefinition Width="60"/>
                </Grid.ColumnDefinitions>
                <!-- Afficher le type d'interface dans la colonne Interface uniquement -->
                <Border Grid.Column="1" CornerRadius="3" Padding="3,1" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Border.Background>
                        <SolidColorBrush Color="{Binding CouleurInterface}"/>
                    </Border.Background>
                    <TextBlock Text="{Binding TypeInterface}" Style="{StaticResource CellStyle}" FontSize="9" FontWeight="Bold" Foreground="White"/>
                </Border>
            </Grid>
        </DataTemplate>

        <local:ResultatTemplateSelector x:Key="ResultatTemplateSelector"
                                        CoucheTemplate="{StaticResource CoucheTemplate}"
                                        InterfaceTemplate="{StaticResource InterfaceTemplate}"/>

    </UserControl.Resources>

    <Grid>
        <ScrollViewer VerticalScrollBarVisibility="Auto" Background="#F5F5F5" Padding="20">
            <StackPanel Margin="0,0,0,40">

                <!-- En-tete simplifie avec seulement 2 boutons -->
                <Border Style="{StaticResource CardStyle}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Resultats de Calcul des Sollicitations" Style="{StaticResource TitleStyle}"/>
                            
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Duree: " Style="{StaticResource InfoStyle}"/>
                                <TextBlock Text="{Binding CalculationDuration}" Style="{StaticResource InfoStyle}"/>
                                <TextBlock Text=" - " Style="{StaticResource InfoStyle}" Margin="10,0"/>
                                <TextBlock Text="Elements: " Style="{StaticResource InfoStyle}"/>
                                <TextBlock Text="{Binding Resultats.Count}" Style="{StaticResource InfoStyle}"/>
                            </StackPanel>
                            
                            <!-- Information de calcul toujours visible -->
                            <StackPanel Margin="0,8,0,0">
                                <TextBlock Text="{Binding CalculationInfo}" Style="{StaticResource InfoStyle}" FontStyle="Italic"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Bouton d'aide avec details integres -->
                        <Button Grid.Column="1" Style="{StaticResource HelpButtonStyle}" Command="{Binding ShowHelpCommand}" Content="? Aide et Details" Margin="0,0,10,0" ToolTip="Afficher l'aide complete avec details de calcul"/>

                        <!-- Bouton recalculer -->
                        <Button Grid.Column="2" Style="{StaticResource ActionButtonStyle}" Command="{Binding CalculateStructureCommand}" Content="Recalculer"/>
                    </Grid>
                </Border>

                <!-- Validation globale de la structure -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel>
                        <TextBlock Text="Validation de la Structure" Style="{StaticResource TitleStyle}"/>
                        
                        <Border CornerRadius="6" Padding="15" Margin="0,8,0,0">
                            <Border.Background>
                                <SolidColorBrush Color="{Binding ValidationColor}"/>
                            </Border.Background>
                            <StackPanel>
                                <TextBlock Text="{Binding ValidationMessage}" Foreground="White" FontSize="16" FontWeight="Bold" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding ValidationSummary}" Foreground="White" FontSize="14" FontWeight="Normal" HorizontalAlignment="Center" Margin="0,5,0,0" Opacity="0.9"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Border>

                <!-- Tableau des resultats detailles -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel>
                        <TextBlock Text="Resultats Detailles par Couche (Style Alize Compact)" Style="{StaticResource TitleStyle}"/>

                        <Border Background="#E9ECEF" CornerRadius="6,6,0,0" Padding="5" Margin="0,10,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="50"/>
                                    <ColumnDefinition Width="85"/>
                                    <ColumnDefinition Width="100"/>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="55"/>
                                    <ColumnDefinition Width="70"/><!-- Critere -->
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="60"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0" Text="N" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="1" Text="Interface" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="2" Text="Nature" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="3" Text="Materiau" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="4" Text="Niveau (cm)" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="5" Text="Module (MPa)" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="6" Text="nu" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="7" Text="Critere" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="8" Text="sigT (MPa)" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="9" Text="epsT (udef)" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="10" Text="sigZ (MPa)" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="11" Text="epsZ (udef)" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="12" Text="w (mm/100)" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="13" Text="Val. Adm." Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                                <TextBlock Grid.Column="14" Text="OK" Style="{StaticResource CellStyle}" FontWeight="Bold"/>
                            </Grid>
                        </Border>

                        <ItemsControl ItemsSource="{Binding Resultats}" ItemTemplateSelector="{StaticResource ResultatTemplateSelector}"/>

                        <TextBlock Text="Aucun resultat disponible. Cliquez sur 'Recalculer' pour generer les resultats." Style="{StaticResource InfoStyle}" HorizontalAlignment="Center" Margin="20" Visibility="{Binding Resultats.Count, Converter={StaticResource CountToVisibilityConverter}}"/>
                    </StackPanel>
                </Border>

                <!-- Nouveau tableau calcul inverse -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel>
                        <TextBlock Text="Calcul Inverse - Capacite Fatigue / Ornierage" Style="{StaticResource TitleStyle}"/>
                        <TextBlock Text="Determination de NEmax a partir des sollicitations calculees et des parametres fatigue" Style="{StaticResource InfoStyle}"/>
                        <ScrollViewer HorizontalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding ResultatsInverse}">
                                <ItemsControl.Resources>
                                    <!-- Style local avec police agrandie pour ce tableau -->
                                    <Style TargetType="TextBlock" x:Key="InvCell" BasedOn="{StaticResource NumericCellStyle}">
                                        <Setter Property="FontSize" Value="11"/>
                                        <Setter Property="Padding" Value="2"/>
                                    </Style>
                                </ItemsControl.Resources>
                                <ItemsControl.Template>
                                    <ControlTemplate TargetType="ItemsControl">
                                        <StackPanel>
                                            <Border Background="#E9ECEF" Padding="4" Margin="0,0,0,4">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="40"/><!-- N -->
                                                        <ColumnDefinition Width="90"/><!-- Nature -->
                                                        <ColumnDefinition Width="140"/><!-- Materiau -->
                                                        <ColumnDefinition Width="60"/><!-- Critere -->
                                                        <ColumnDefinition Width="60"/><!-- sigT -->
                                                        <ColumnDefinition Width="60"/><!-- epsT -->
                                                        <ColumnDefinition Width="70"/><!-- sigZ -->
                                                        <ColumnDefinition Width="70"/><!-- epsZ -->
                                                        <ColumnDefinition Width="70"/><!-- CAM -->
                                                        <ColumnDefinition Width="80"/><!-- NPL -->
                                                        <ColumnDefinition Width="80"/><!-- Accr. -->
                                                        <ColumnDefinition Width="80"/><!-- Risque -->
                                                        <ColumnDefinition Width="70"/><!-- NE -->
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="N" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="1" Text="Nature" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="2" Text="Materiau" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="3" Text="Critere" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="4" Text="sigT" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="5" Text="epsT" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="6" Text="sigZ" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="7" Text="epsZ" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="8" Text="CAM" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="9" Text="NPL" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="10" Text="Accr." Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="11" Text="Risque" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                    <TextBlock Grid.Column="12" Text="NE" Style="{StaticResource CellStyle}" FontWeight="Bold" FontSize="12"/>
                                                </Grid>
                                            </Border>
                                            <ItemsPresenter/>
                                        </StackPanel>
                                    </ControlTemplate>
                                </ItemsControl.Template>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Margin="0,0,0,2" Background="#F8F9FA" Padding="3">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="40"/>
                                                    <ColumnDefinition Width="90"/>
                                                    <ColumnDefinition Width="140"/>
                                                    <ColumnDefinition Width="60"/>
                                                    <ColumnDefinition Width="60"/>
                                                    <ColumnDefinition Width="60"/>
                                                    <ColumnDefinition Width="70"/>
                                                    <ColumnDefinition Width="70"/>
                                                    <ColumnDefinition Width="70"/>
                                                    <ColumnDefinition Width="80"/>
                                                    <ColumnDefinition Width="80"/>
                                                    <ColumnDefinition Width="80"/>
                                                    <ColumnDefinition Width="70"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="{Binding Numero}" Style="{StaticResource InvCell}"/>
                                                <TextBlock Grid.Column="1" Text="{Binding Nature}" Style="{StaticResource InvCell}"/>
                                                <TextBlock Grid.Column="2" Text="{Binding Materiau}" Style="{StaticResource InvCell}" TextAlignment="Left"/>
                                                <TextBlock Grid.Column="3" Text="{Binding Critere}" Style="{StaticResource InvCell}"/>
                                                <TextBlock Grid.Column="4" Text="{Binding SigmaT, StringFormat='{}{0:F3}'}" Style="{StaticResource InvCell}"/>
                                                <TextBlock Grid.Column="5" Text="{Binding EpsilonT, StringFormat='{}{0:F1}'}" Style="{StaticResource InvCell}"/>
                                                <TextBlock Grid.Column="6" Text="{Binding SigmaZ, StringFormat='{}{0:F3}'}" Style="{StaticResource InvCell}"/>
                                                <TextBlock Grid.Column="7" Text="{Binding EpsilonZ, StringFormat='{}{0:F1}'}" Style="{StaticResource InvCell}"/>
                                                <TextBlock Grid.Column="8" Text="{Binding CAM, StringFormat='{}{0:F3}'}" Style="{StaticResource InvCell}"/>
                                                <TextBlock Grid.Column="9" Text="{Binding TraficCumulePL, StringFormat='{}{0:N0}'}" Style="{StaticResource InvCell}"/>
                                                <TextBlock Grid.Column="10" Text="{Binding TypeAccroissement}" Style="{StaticResource InvCell}"/>
                                                <TextBlock Grid.Column="11" Text="{Binding Risque, StringFormat='{}{0:F1}'}" Style="{StaticResource InvCell}"/>
                                                <TextBlock Grid.Column="12" Text="{Binding TraficCumuleNE, StringFormat='{}{0:N0}'}" Style="{StaticResource InvCell}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </StackPanel>
                </Border>

                <!-- Indicateur de calcul en cours -->
                <Border Style="{StaticResource CardStyle}" Background="#007ACC" Visibility="{Binding IsCalculationInProgress, Converter={StaticResource BoolToVis}}">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="Calcul des sollicitations en cours..." Foreground="White" FontSize="16" FontWeight="Bold"/>
                    </StackPanel>
                </Border>

            </StackPanel>
        </ScrollViewer>

        <!-- Popup d'aide COMPLETE avec details integres -->
        <Border Visibility="{Binding IsHelpVisible, Converter={StaticResource BoolToVis}}" Background="#80000000" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
            <Border Background="White" CornerRadius="12" MaxWidth="1200" MaxHeight="800" Margin="30" HorizontalAlignment="Center" VerticalAlignment="Center">
                <Border.Effect>
                    <DropShadowEffect Color="Black" BlurRadius="10" ShadowDepth="0" Opacity="0.3"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- En-tete du popup -->
                    <Border Grid.Row="0" Background="#007ACC" CornerRadius="12,12,0,0" Padding="20,15">
                        <Grid>
                            <TextBlock Text="Aide Complete - Resultats et Details de Calcul (NF P98-086)" Style="{StaticResource TitleStyle}" Foreground="White" FontSize="18" Margin="0"/>
                            <Button Content="X" Command="{Binding HideHelpCommand}" HorizontalAlignment="Right" Background="Transparent" BorderThickness="0" Foreground="White" FontSize="18" FontWeight="Bold" Padding="10,5" Cursor="Hand"/>
                        </Grid>
                    </Border>

                    <!-- Contenu du popup avec toutes les sections -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="20">
                        <StackPanel>
                            
                            <!-- === SECTION 1: DETAILS DE CALCUL ACTUEL === -->
                            <Border Background="#F8F9FA" CornerRadius="8" Padding="15" Margin="0,0,0,15">
                                <StackPanel>
                                    <TextBlock Text="Details du Calcul Actuel" FontWeight="Bold" FontSize="16" Foreground="#007ACC" Margin="0,0,0,10"/>
                                    
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <StackPanel Grid.Column="0" Margin="0,0,15,0">
                                            <TextBlock Text="Performance :" FontWeight="Bold" FontSize="12" Margin="0,0,0,2"/>
                                            <TextBlock Text="{Binding CalculationDuration}" FontSize="11" Margin="5,0,0,5"/>
                                            
                                            <TextBlock Text="Elements :" FontWeight="Bold" FontSize="12" Margin="0,0,0,2"/>
                                            <TextBlock Text="{Binding Resultats.Count}" FontSize="11" Margin="5,0,0,5"/>
                                            
                                            <TextBlock Text="Validation :" FontWeight="Bold" FontSize="12" Margin="0,0,0,2"/>
                                            <TextBlock Text="{Binding ValidationSummary}" FontSize="11" Margin="5,0,0,5"/>
                                        </StackPanel>
                                        
                                        <StackPanel Grid.Column="1">
                                            <TextBlock Text="Structure :" FontWeight="Bold" FontSize="12" Margin="0,0,0,2"/>
                                            <TextBlock Text="{Binding CalculationInfo}" FontSize="10" TextWrapping="Wrap" Margin="5,0,0,5"/>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- === SECTION 2: GUIDE DES NOTATIONS === -->
                            <Border Background="#E7F3FF" CornerRadius="8" Padding="15" Margin="0,0,0,15">
                                <StackPanel>
                                    <TextBlock Text="Guide des Notations" FontWeight="Bold" FontSize="16" Foreground="#007ACC" Margin="0,0,0,10"/>
                                    
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Grid.Column="0" Margin="0,0,15,0">
                                            <TextBlock Text="- sigT : Contrainte horizontale (MPa)" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- sigZ : Contrainte verticale (MPa)" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- epsT : Deformation horizontale (udef)" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- epsZ : Deformation verticale (udef)" FontSize="11" Margin="0,1"/>
                                        </StackPanel>

                                        <StackPanel Grid.Column="1">
                                            <TextBlock Text="- w : Deflexion (mm/100)" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- nu : Coefficient de Poisson" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- Sup/Inf : Haut et bas de couche" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- udef = micro-deformations" FontSize="11" Margin="0,1"/>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- === SECTION 3: VALIDATION === -->
                            <Border Background="#E8F5E8" CornerRadius="8" Padding="15" Margin="0,0,0,15">
                                <StackPanel>
                                    <TextBlock Text="Criteres de Validation NF P98-086" FontWeight="Bold" FontSize="16" Foreground="#28a745" Margin="0,0,0,10"/>
                                    
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Grid.Column="0" Margin="0,0,15,0">
                                            <TextBlock Text="- Fatigue flexion : epsT" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- Fatigue traction : sigT" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- Ornieriage : epsZ" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- Enrobes : epsT moins 100 udef" FontSize="11" Margin="0,1"/>
                                        </StackPanel>

                                        <StackPanel Grid.Column="1">
                                            <TextBlock Text="- MTLH : epsT moins 120 udef" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- GNT : epsZ moins 80 udef" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- Vert = Valide" FontSize="11" Margin="0,1"/>
                                            <TextBlock Text="- Rouge = Non conforme" FontSize="11" Margin="0,1"/>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- === SECTION 4: INTERFACES === -->
                            <Border Background="#FFF3CD" CornerRadius="8" Padding="15">
                                <StackPanel>
                                    <TextBlock Text="Types d'Interfaces" FontWeight="Bold" FontSize="16" Foreground="#856404" Margin="0,0,0,10"/>
                                    
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,2">
                                            <Border Background="#28a745" CornerRadius="3" Padding="5,2" Margin="0,0,10,0">
                                                <TextBlock Text="Collee" Foreground="White" FontSize="10" FontWeight="Bold"/>
                                            </Border>
                                            <TextBlock Text="Adherence parfaite" FontSize="11" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        
                                        <StackPanel Orientation="Horizontal" Margin="0,2">
                                            <Border Background="#ffc107" CornerRadius="3" Padding="5,2" Margin="0,0,10,0">
                                                <TextBlock Text="Semi-collee" Foreground="White" FontSize="10" FontWeight="Bold"/>
                                            </Border>
                                            <TextBlock Text="Adherence partielle" FontSize="11" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        
                                        <StackPanel Orientation="Horizontal" Margin="0,2">
                                            <Border Background="#dc3545" CornerRadius="3" Padding="5,2" Margin="0,0,10,0">
                                                <TextBlock Text="Decollee" Foreground="White" FontSize="10" FontWeight="Bold"/>
                                            </Border>
                                            <TextBlock Text="Glissement libre" FontSize="11" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                        </StackPanel>
                    </ScrollViewer>

                    <!-- Pied du popup -->
                    <Border Grid.Row="2" Background="#f8f9fa" CornerRadius="0,0,12,12" Padding="15">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <Button Content="Recalculer" Command="{Binding CalculateStructureCommand}" Style="{StaticResource ActionButtonStyle}" Margin="0,0,10,0" Padding="15,8"/>
                            <Button Content="Fermer" Command="{Binding HideHelpCommand}" Style="{StaticResource ActionButtonStyle}" Background="#dc3545" Padding="15,8"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
        </Border>
    </Grid>
</UserControl>