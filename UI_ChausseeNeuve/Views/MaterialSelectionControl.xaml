<UserControl
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="clr-namespace:UI_ChausseeNeuve.Views"
    xmlns:viewModels="clr-namespace:UI_ChausseeNeuve.ViewModels"
    x:Class="UI_ChausseeNeuve.Views.MaterialSelectionControl"
    mc:Ignorable="d"
    d:DesignHeight="400"
    d:DesignWidth="900"
    FontFamily="Segoe UI">

    <UserControl.Resources>
        <!-- DataTemplates pour chaque type de matériau -->
        <DataTemplate DataType="{x:Type viewModels:MateriauxBeninViewModel}">
            <Grid>
                <ListBox Style="{StaticResource ModernListBoxStyle}"
                         ItemsSource="{Binding AvailableMaterials}"
                         SelectedItem="{Binding SelectedMaterial, Mode=TwoWay}"
                         DisplayMemberPath="Name"
                         SelectionChanged="MaterialSelectionChanged"
                         Background="Transparent"
                         BorderThickness="0"/>
            </Grid>
        </DataTemplate>
        <!-- Style pour le tableau -->
        <Style x:Key="BitumeGridViewHeader"
                TargetType="GridViewColumnHeader">
            <Setter Property="FontWeight"
                    Value="Bold"/>
            <Setter Property="Background"
                    Value="#FF1F1F1F"/>
            <Setter Property="Foreground"
                    Value="White"/>
            <Setter Property="Padding"
                    Value="6,2"/>
            <Setter Property="BorderBrush"
                    Value="#444"/>
            <Setter Property="BorderThickness"
                    Value="0,0,1,1"/>
        </Style>
        <Style x:Key="MaterialListViewStyle"
                TargetType="ListView">
            <Setter Property="Background"
                    Value="#181A1B"/>
            <Setter Property="BorderBrush"
                    Value="#222"/>
            <Setter Property="BorderThickness"
                    Value="1"/>
        </Style>
        <Style x:Key="MaterialGridViewColumn"
                TargetType="GridViewColumnHeader">
            <Setter Property="Background"
                    Value="#FF1F1F1F"/>
            <Setter Property="Foreground"
                    Value="White"/>
            <Setter Property="BorderBrush"
                    Value="#444"/>
            <Setter Property="BorderThickness"
                    Value="0,0,1,1"/>
        </Style>
        <DataTemplate DataType="{x:Type viewModels:CatalogueSenegalaisViewModel}">
            <Grid>
                <ListBox Style="{StaticResource ModernListBoxStyle}"
                         ItemsSource="{Binding AvailableMaterials}"
                         SelectedItem="{Binding SelectedMaterial, Mode=TwoWay}"
                         DisplayMemberPath="Name"
                         SelectionChanged="MaterialSelectionChanged"
                         Background="#FF2D2D30"
                         BorderThickness="0"/>
            </Grid>
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewModels:CatalogueFrancaisViewModel}">
            <Grid>
                <ListBox Style="{StaticResource ModernListBoxStyle}"
                         ItemsSource="{Binding AvailableMaterials}"
                         SelectedItem="{Binding SelectedMaterial, Mode=TwoWay}"
                         DisplayMemberPath="Name"
                         SelectionChanged="MaterialSelectionChanged"
                         Background="Transparent"
                         BorderThickness="0"/>
            </Grid>
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewModels:NFP98ViewModel}">
            <Grid>
                <ListView Style="{StaticResource MaterialListViewStyle}"
                          ItemsSource="{Binding Path=AvailableMaterials}"
                          SelectedItem="{Binding Path=SelectedMaterial, Mode=TwoWay}"
                          Margin="8">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="Nom"
                                    DisplayMemberBinding="{Binding Name}"
                                    Width="140"/>
                            <GridViewColumn Header="Famille"
                                    DisplayMemberBinding="{Binding MaterialFamily}"
                                    Width="100"/>
                            <GridViewColumn Header="Catégorie"
                                    DisplayMemberBinding="{Binding Category}"
                                    Width="80"/>
                            <GridViewColumn Header="Module E (MPa)"
                                    DisplayMemberBinding="{Binding ComputedModulus, StringFormat=N0}"
                                    Width="90"/>
                            <GridViewColumn Header="ν"
                                    DisplayMemberBinding="{Binding PoissonRatio}"
                                    Width="50"/>
                            <GridViewColumn Header="Ép. min (m)"
                                    DisplayMemberBinding="{Binding MinThickness_m}"
                                    Width="70"/>
                            <GridViewColumn Header="Ép. max (m)"
                                    DisplayMemberBinding="{Binding MaxThickness_m}"
                                    Width="70"/>
                            <GridViewColumn Header="Statut"
                                    DisplayMemberBinding="{Binding Statut}"
                                    Width="70"/>
                            <GridViewColumn Header="Sigma6 (MPa)"
                                    DisplayMemberBinding="{Binding Sigma6}"
                                    Width="80"/>
                            <GridViewColumn Header="-1/b"
                                    DisplayMemberBinding="{Binding InverseB}"
                                    Width="60"/>
                            <GridViewColumn Header="Sl"
                                    DisplayMemberBinding="{Binding Sl}"
                                    Width="50"/>
                            <GridViewColumn Header="Sh (m)"
                                    DisplayMemberBinding="{Binding Sh}"
                                    Width="60"/>
                            <GridViewColumn Header="Kc"
                                    DisplayMemberBinding="{Binding Kc}"
                                    Width="50"/>
                            <GridViewColumn Header="Kd"
                                    DisplayMemberBinding="{Binding Kd}"
                                    Width="50"/>
                            <GridViewColumn Header="Source"
                                    DisplayMemberBinding="{Binding Source}"
                                    Width="120"/>
                            <GridViewColumn Header="Description"
                                    DisplayMemberBinding="{Binding Description}"
                                    Width="180"/>
                        </GridView>
                    </ListView.View>
                </ListView>
            </Grid>
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewModels:MateriauxUserViewModel}">
            <Grid>
                <ListBox Style="{StaticResource ModernListBoxStyle}"
                         ItemsSource="{Binding AvailableMaterials}"
                         SelectedItem="{Binding SelectedMaterial, Mode=TwoWay}"
                         DisplayMemberPath="Name"
                         SelectionChanged="MaterialSelectionChanged"
                         Background="#FF120D0D"
                         BorderThickness="0"/>
            </Grid>
        </DataTemplate>
        <local:StatutCellBgConverter x:Key="StatutCellBgConverter"/>
        <!-- Converter for Category to Visibility -->
        <local:CategoryToVisibilityConverter x:Key="CategoryToVisibility"/>
    </UserControl.Resources>

    <Grid Background="{StaticResource PrimaryBg}">
        <!-- Message d'attente de sélection -->
        <TextBlock Text="Veuillez sélectionner une catégorie pour afficher les matériaux."
                   FontStyle="Italic"
                Style="{StaticResource InfoTextStyle}"
                   HorizontalAlignment="Center"
                VerticalAlignment="Center"
                   Visibility="{Binding SelectedCategory, Converter={StaticResource CategoryToVisibility}, ConverterParameter=NONE}"/>

        <!-- Tableau des matériaux bitumineux (MB) avec ScrollViewer large -->
        <ScrollViewer HorizontalScrollBarVisibility="Auto"
                VerticalScrollBarVisibility="Auto"
                      Visibility="{Binding SelectedCategory, Converter={StaticResource CategoryToVisibility}, ConverterParameter=MB}">
            <StackPanel>
                <!-- Contrôles température/fréquence, style carte -->
                <Border Style="{StaticResource SectionCardStyle}"
                        Padding="16,10,16,10"
                        Margin="0,0,0,12"
                        HorizontalAlignment="Left">
                    <StackPanel Orientation="Horizontal"
                            VerticalAlignment="Center"
                            Margin="0,0,0,8">
                        <!-- Température -->
                        <StackPanel Orientation="Horizontal"
                                Margin="0,0,32,0"
                                VerticalAlignment="Bottom">
                            <TextBlock Text="Teq ="
                                    Style="{StaticResource LabelStyle}"
                                    FontSize="15"
                                    Margin="0,0,8,0"
                                    VerticalAlignment="Center"/>
                            <Button Style="{StaticResource RoundedArrowButtonStyle}"
                                    Click="OnTemperatureDown"
                                    Cursor="Hand"
                                    Focusable="True">
                                <TextBlock Text="◄"/>
                            </Button>
                            <Border Style="{StaticResource ValueBoxBorderStyle}">
                                <StackPanel Orientation="Horizontal"
                                        VerticalAlignment="Center">
                                    <TextBlock Text="{Binding CurrentMaterialViewModel.SelectedTemperature}"
                                            Style="{StaticResource ValueNumberTextStyle}"/>
                                    <TextBlock Text="°C"
                                            Style="{StaticResource ValueUnitTextStyle}"/>
                                </StackPanel>
                            </Border>
                            <Button Style="{StaticResource RoundedArrowButtonStyle}"
                                    Margin="0,0,0,0"
                                    Click="OnTemperatureUp"
                                    Cursor="Hand"
                                    Focusable="True">
                                <TextBlock Text="►"/>
                            </Button>
                        </StackPanel>
                        <!-- Fréquence -->
                        <StackPanel Orientation="Horizontal"
                                VerticalAlignment="Bottom">
                            <TextBlock Text="Fr ="
                                    Style="{StaticResource LabelStyle}"
                                    FontSize="15"
                                    Margin="0,0,8,0"
                                    VerticalAlignment="Center"/>
                            <Button Style="{StaticResource RoundedArrowButtonStyle}"
                                    Click="OnFrequenceDown"
                                    Cursor="Hand"
                                    Focusable="True">
                                <TextBlock Text="◄"/>
                            </Button>
                            <Border Style="{StaticResource ValueBoxBorderStyle}">
                                <StackPanel Orientation="Horizontal"
                                        VerticalAlignment="Center">
                                    <TextBlock Text="{Binding CurrentMaterialViewModel.SelectedFrequence}"
                                            Style="{StaticResource ValueNumberTextStyle}"/>
                                    <TextBlock Text="Hz"
                                            Style="{StaticResource ValueUnitTextStyle}"/>
                                </StackPanel>
                            </Border>
                            <Button Style="{StaticResource RoundedArrowButtonStyle}"
                                    Margin="0,0,0,0"
                                    Click="OnFrequenceUp"
                                    Cursor="Hand"
                                    Focusable="True">
                                <TextBlock Text="►"/>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </Border>
                <!-- Debug: show number of loaded materials -->
                <TextBlock Margin="8,4,8,4"
                        Foreground="LightGray"
                        FontStyle="Italic"
                        HorizontalAlignment="Left"
                           Text="{Binding CurrentMaterialViewModel.AvailableMaterials.Count, StringFormat='Matériaux chargés: {0}'}"/>
                <Border Style="{StaticResource SectionCardStyle}"
                        Padding="0"
                        Margin="0">
                    <ListView x:Name="BitumeListView"
                              ItemsSource="{Binding CurrentMaterialViewModel.AvailableMaterials}"
                              SelectedItem="{Binding CurrentMaterialViewModel.SelectedMaterial, Mode=TwoWay}"
                              SelectionChanged="MaterialSelectionChanged"
                              Margin="0"
                              MinWidth="1200"
                              AlternationCount="2"
                              ItemContainerStyle="{StaticResource MaterialListViewItemStyle}">
                        <ListView.View>
                            <GridView>
                                <!-- Toutes les colonnes avec HeaderTemplate noir -->
                                <GridViewColumn Header="Statut"
                                        Width="80">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="Statut"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="0">
                                                <TextBlock Text="{Binding Statut}"
                                                        Foreground="White"
                                                        FontWeight="Bold"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Nom"
                                        DisplayMemberBinding="{Binding Name}"
                                        Width="140">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="Nom"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="E (MPa)"
                                        DisplayMemberBinding="{Binding ComputedModulus, StringFormat=N0}"
                                        Width="100">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="E (MPa)"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="ν"
                                        DisplayMemberBinding="{Binding PoissonRatio}"
                                        Width="60">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="ν"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Epsi0 (10°C)"
                                        DisplayMemberBinding="{Binding Epsi0_10C}"
                                        Width="100">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="Epsi0 (10°C)"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="-1/b"
                                        DisplayMemberBinding="{Binding InverseB}"
                                        Width="70">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="-1/b"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="SN"
                                        DisplayMemberBinding="{Binding SN}"
                                        Width="70">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="SN"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Sh"
                                        DisplayMemberBinding="{Binding Sh}"
                                        Width="70">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="Sh"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Kc"
                                        DisplayMemberBinding="{Binding Kc}"
                                        Width="70">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="Kc"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="E(-10°C)"
                                        DisplayMemberBinding="{Binding EvsTemperature[-10]}"
                                        Width="100">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="E(-10°C)"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="E(0°C)"
                                        DisplayMemberBinding="{Binding EvsTemperature[0]}"
                                        Width="100">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="E(0°C)"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="E(10°C)"
                                        DisplayMemberBinding="{Binding EvsTemperature[10]}"
                                        Width="100">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="E(10°C)"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="E(20°C)"
                                        DisplayMemberBinding="{Binding EvsTemperature[20]}"
                                        Width="100">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="E(20°C)"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="E(30°C)"
                                        DisplayMemberBinding="{Binding EvsTemperature[30]}"
                                        Width="100">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="E(30°C)"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="E(40°C)"
                                        DisplayMemberBinding="{Binding EvsTemperature[40]}"
                                        Width="100">
                                    <GridViewColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="#FF1F1F1F"
                                                    Padding="4,2"
                                                    CornerRadius="2">
                                                <TextBlock Text="E(40°C)"
                                                        Style="{StaticResource TableHeaderStyle}"
                                                        Foreground="White"
                                                        FontSize="15"/>
                                            </Border>
                                        </DataTemplate>
                                    </GridViewColumn.HeaderTemplate>
                                </GridViewColumn>
                            </GridView>
                        </ListView.View>
                    </ListView>
                </Border>
            </StackPanel>
        </ScrollViewer>
        <ContentControl Content="{Binding CurrentMaterialViewModel}"
                DataContext="{Binding CurrentMaterialViewModel}"
                Background="#FF3C3C3C"
                AutomationProperties.IsColumnHeader="True"
                AutomationProperties.IsRowHeader="True"
                AutomationProperties.IsRequiredForForm="True"/>
    </Grid>
</UserControl>
